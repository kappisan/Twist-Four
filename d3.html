<!DOCTYPE html>
<meta charset="utf-8">

<style>

* {
	margin: 0;
	padding: 0;
}

.segment {
    fill: #9000aa;
}

.empty-square {
	fill: #CCC;
}

.empty-square:hover {
	fill: #DDD;
}


.red-square {
	fill: #C00;
}

.blue-square {
	fill: #00C;
}

svg {
	position: relative;
	margin: auto;
	left: 0;
	right: 0;
}

.board {

}

</style>

<body>

<script src="./libs/jquery.min.js"></script>
<script src="./libs/d3.min.js"></script>

<div id="move">p1place</div>
<button onclick="reset()">reset</button>

<svg class="board"></svg>

<script>

var width = 600,
    height = 700,
    segmentGap = 4,
    squareRows = 2,
    segmentRows = 2,
    squarePadding = 4,
    segmentSize = (width / segmentRows) - (segmentRows * segmentGap),
    squareSize = (segmentSize / squareRows) - (squareRows * squarePadding);

    segmentSize -= squarePadding;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);



var board = [];

var segmentsOnBoard = segmentRows * segmentRows;
var squaresPerSeg = squareRows * squareRows; 

for(var i = 0; i < segmentsOnBoard; i++) {

	var seg = [];
	for(var j = 0; j < squaresPerSeg; j++) {
		seg.push(["blank"]);
	}
	board.push(seg);
}

var move = "p1place";

function drawBoard() {
	board.forEach(function(d,currentSeg) {

		var phi0 = 90;

		var g = svg.append("g")
				    .attr("x", function() {
				    	if(currentSeg == 0 || currentSeg == 1) return 0;
				    	else return segmentSize + segmentGap;
				    })
				    .attr("y", function() {
				    	if(currentSeg == 0 || currentSeg == 2) return 0;
				    	else return segmentSize + segmentGap;
				    })
				    .attr("class", "segGroup"+currentSeg)
				    .attr("height", segmentSize)
			    	.attr("width", segmentSize)
			    	//.attr("transform", "translate(150, 150)")
			    	.on("click", function() {
			    		console.log("group clicked", g);
			    		var twisting = true;
			    		var angle = 0;
			    		var t0 = Date.now();

						d3.timer(function() {

							var gCenterX = segmentSize / 2;
							var gCenterY = segmentSize / 2;

							if(twisting) {
								var delta = (Date.now() - t0);
								svg.select(".segGroup"+currentSeg).selectAll("rect").attr("transform", function() {

									return "rotate(" + delta * 1/25 + ","+gCenterX+","+gCenterY+")";
								});

								if(delta * 1/25 >= 90) {
									svg.select(".segGroup"+currentSeg).selectAll("rect").attr("transform", function() {
										return "rotate(90,"+gCenterX+","+gCenterY+")";
									});										
									twisting = false;
								}
							}
						});

						if(!twisting) return;

			    	});

		g.append("rect")
		    .attr("class", "segment s"+currentSeg)
		    .attr("x", function() {
		    	if(currentSeg == 0 || currentSeg == 1) return 0;
		    	else return segmentSize + segmentGap;
		    })
		    .attr("y", function() {
		    	if(currentSeg == 0 || currentSeg == 2) return 0;
		    	else return segmentSize + segmentGap;
		    })
		    .attr("height", segmentSize)
		    .attr("width", segmentSize);

		d.forEach(function(s,j) {

			g.append("rect")
			    .attr("class", function() {
			    	if(s == "blank") return "empty-square";
			    	else if(s == "red") return "red-square";
			    	else if(s == "blue") return "blue-square";
			    	else return "empty-square";
			    })
			    .attr("x", function() {
			    	if(j == 0 || j == 1) return squarePadding;
			    	else return squareSize + (2 * squarePadding);
			    })
			    .attr("y", function() {
			    	if(j == 0 || j == 2) return squarePadding;
			    	else return squareSize + (2 * squarePadding);
			    })
			    .attr("transform", function() {
			    	if(currentSeg == 1) return "translate(0, "+(segmentSize+segmentGap)+")";
			    	if(currentSeg == 2) return "translate("+(segmentSize+segmentGap)+", 0)";
			    	if(currentSeg == 3) return "translate("+(segmentSize+segmentGap)+", "+(segmentSize+segmentGap)+")";
			    })
			    .attr("height", squareSize)
			    .attr("width", squareSize)
			    .on("click", function(d) {
			    	console.log("d", j, currentSeg, s, this);
			    	console.log("segment", currentSeg);

			    	if(move == "p1place") {
			    		d3.select(this).attr("class", "red-square");
			    		move = "p2place";
			    	} else {
			    		d3.select(this).attr("class", "blue-square");
			    		move = "p1place";
			    	}

			    	document.getElementById("move").innerHTML = "" + move;
			    })
		});

	});
}

drawBoard();

function reset() {
	console.log("reset");
	svg.selectAll("*").remove(),
	drawBoard();
}

</script>