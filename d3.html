<!DOCTYPE html>
<meta charset="utf-8">

<style>

* {
	margin: 0;
	padding: 0;
}

.segment {
    fill: #9000aa;
}

.empty-square {
	fill: #CCC;
}

.empty-square:hover {
	fill: #DDD;
}


.red-square {
	fill: #C00;
}

.blue-square {
	fill: #00C;
}

svg {
	position: relative;
	margin: auto;
	left: 0;
	right: 0;
}

.board {

}

</style>

<body>

<script src="./libs/jquery.min.js"></script>
<script src="./libs/d3.min.js"></script>

<div id="move">p1place</div>
<button onclick="reset()">reset</button>

<svg class="board"></svg>

<script>

var width = 600,
    height = 700,
    segmentGap = 4,
    squareRows = 2,
    segmentRows = 2,
    squarePadding = 4,
    segmentSize = (width / segmentRows) - (segmentRows * segmentGap),
    squareSize = (segmentSize / squareRows) - (squareRows * squarePadding);

    segmentSize -= squarePadding;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);



var board = [];
var _board = [];

var segmentsOnBoard = segmentRows * segmentRows;
var squaresPerSeg = squareRows * squareRows; 

for(var i = 0; i < segmentsOnBoard; i++) {

	var x = segmentSize + segmentGap;
	if(i == 0 || i == 1) x = 0;

	var y = segmentSize + segmentGap;
	if(i == 0 || i == 2) y = 0;

	var seg = { 
		x: x, 
		y: y,
		angle: 0,
		centerx: x + (segmentSize / 2),
		centery: y + (segmentSize / 2),
		squares: []
	}

	for(var j = 0; j < squaresPerSeg; j++) {

		var sx = squareSize + (2 * squarePadding);
		if(j == 0 || j == 1) sx = squarePadding;


		var sy = squareSize + (2 * squarePadding);
		if(j == 0 || j == 2) sy = squarePadding;

		var sqr = { 
			x: sx, 
			y: sy,
			parent: i,
			angle: 0,
			state: "blank",
			squares: []
		}

		seg.squares.push(sqr);
	}

	board.push(seg.squares);
	_board.push(seg);
}

console.log("_board", _board);

var move = "p1place";

function drawBoard() {
	_board.forEach(function(segment, currentSeg) {

		// segment group
		var g = svg.append("g")
				    .attr("x", function() { return segment.x; })
				    .attr("y", function() { return segment.y; })
				    .attr("class", "segGroup"+currentSeg)
				    .attr("height", segmentSize)
			    	.attr("width", segmentSize)
			    	.on("click", function() {

			    		console.log("get transform", d3.select(this)[0][0]);
			    		console.log("group clicked", g);

			    		var twisting = true;
			    		var angle = 0;
			    		var t0 = Date.now();

						d3.timer(function() {

							var gCenterX = segment.centerx;
							var gCenterY = segment.centery;



							if(twisting) {
								var delta = (Date.now() - t0);
								g.selectAll("rect").attr("transform", function() {
									return "rotate(" + delta * 1/25 + ","+gCenterX+","+gCenterY+")";
								});

								// return conditions
								if(delta * 1/25 >= 90) {
									g.selectAll("rect").attr("transform", function() {
										return "rotate(90,"+gCenterX+","+gCenterY+")";
									});										
									twisting = false;
								}
							}
						});

						if(!twisting) return;

			    	});

		// segment background
		g.append("rect")
		    .attr("class", "segment s"+currentSeg)
		    .attr("x", function() { return segment.x; })
		    .attr("y", function() { return segment.y; })
		    .attr("height", segmentSize)
		    .attr("width", segmentSize);

		// iterate over squares 
		segment.squares.forEach(function(square,j) {

			console.log("square", square);

			g.append("rect")
			    .attr("class", function() {
			    	if(square.state == "blank") return "empty-square";
			    	else if(square.state == "red") return "red-square";
			    	else if(square.state == "blue") return "blue-square";
			    	else return "empty-square";
			    })
			    .attr("x", function() {
			    	return square.x + segment.x;
			    })
			    .attr("y", function() {
			    	return square.y + segment.y;
			    })
			    .attr("height", squareSize)
			    .attr("width", squareSize)
			    .on("click", function(d) {
			    	console.log("d", j, currentSeg, square, this);
			    	console.log("segment", currentSeg);

			    	if(move == "p1place") {
			    		d3.select(this).attr("class", "red-square");
			    		move = "p2place";
			    	} else {
			    		d3.select(this).attr("class", "blue-square");
			    		move = "p1place";
			    	}

			    	document.getElementById("move").innerHTML = "" + move;
			    })
		});

	});
}

drawBoard();

function reset() {
	console.log("reset");
	svg.selectAll("*").remove(),
	drawBoard();
}

</script>